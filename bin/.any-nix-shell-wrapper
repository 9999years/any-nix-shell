#!/bin/sh
fns () {
    pkg=
    pkgs=$ANY_NIX_SHELL_PKGS
    which_shell="$1"
    shift
    for arg in "$@"; do
        if [[ $arg == -* ]]; then
            pkg=
            if [[ $arg == --pure ]] || [[ $arg == --command ]] || [[ $arg == --run ]]; then
                command nix-shell "$@"
                return
            elif [[ $arg == -p ]] || [[ $arg == --packages ]]; then
                pkg=1
            fi
        elif [[ $pkg == 1 ]]; then
            pkgs+=" "$arg
        fi
    done
    if [[ -n $name ]] && [[ $name != shell ]]; then
        pkgs+=" "$name
    fi
    env ANY_NIX_SHELL_PKGS="$pkgs" nix-shell "$@" \
        --command "export SHELL=\"$(which $which_shell)\"; $which_shell"
}
fns "$@"